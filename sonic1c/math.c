#include "opcodes.h"
#include "system.h"


ROMFUNC(rom_29AC) {
  D1 = read_32(v_random);
  if (D1 == 0) {D1 = 0x2A6D365A;}     // BNE.B	$29B8
  D0 = D1;         // MOVE.L	D1,D0
  D1 <<= 2;         // ASL.L	#$02,D1
  D1 += D0;          // ADD.L	D0,D1
  D1 <<= 3;         // ASL.L	#$03,D1
  D1 += D0;          // ADD.L	D0,D1
  SETWORD(D0, D1);         // MOVE.W	D1,D0
  DEF_ROMLOC(29C4) : swap_reg_16(&D1);               // SWAP.W	D1
  D0 += D1;          // ADD.W	D1,D0
  SETWORD(D1, D0);         // MOVE.W	D0,D1
  DEF_ROMLOC(29CA) : swap_reg_16(&D1);               // SWAP.W	D1
  write_32(v_random, D1);  // MOVE.L	D1,$F636
}
static const s16 Sine_Data[] = {
    0x00,  0x06,  0x0c,   0x12,  0x19,  0x1f,  0x25,  0x2b,  0x31,  0x38,
    0x3e,  0x44,  0x4a,   0x50,  0x56,  0x5c,  0x61,  0x67,  0x6d,  0x73,
    0x78,  0x7e,  0x83,   0x88,  0x8e,  0x93,  0x98,  0x9d,  0xa2,  0xa7,
    0xab,  0xb0,  0xb5,   0xb9,  0xbd,  0xc1,  0xc5,  0xc9,  0xcd,  0xd1,
    0xd4,  0xd8,  0xdb,   0xde,  0xe1,  0xe4,  0xe7,  0xea,  0xec,  0xee,
    0xf1,  0xf3,  0xf4,   0xf6,  0xf8,  0xf9,  0xfb,  0xfc,  0xfd,  0xfe,
    0xfe,  0xff,  0xff,   0xff,  0x100, 0xff,  0xff,  0xff,  0xfe,  0xfe,
    0xfd,  0xfc,  0xfb,   0xf9,  0xf8,  0xf6,  0xf4,  0xf3,  0xf1,  0xee,
    0xec,  0xea,  0xe7,   0xe4,  0xe1,  0xde,  0xdb,  0xd8,  0xd4,  0xd1,
    0xcd,  0xc9,  0xc5,   0xc1,  0xbd,  0xb9,  0xb5,  0xb0,  0xab,  0xa7,
    0xa2,  0x9d,  0x98,   0x93,  0x8e,  0x88,  0x83,  0x7e,  0x78,  0x73,
    0x6d,  0x67,  0x61,   0x5c,  0x56,  0x50,  0x4a,  0x44,  0x3e,  0x38,
    0x31,  0x2b,  0x25,   0x1f,  0x19,  0x12,  0x0c,  0x06,  0x00,  -0x06,
    -0x0c, -0x12, -0x19,  -0x1f, -0x25, -0x2b, -0x31, -0x38, -0x3e, -0x44,
    -0x4a, -0x50, -0x56,  -0x5c, -0x61, -0x67, -0x6d, -0x75, -0x78, -0x7e,
    -0x83, -0x88, -0x8e,  -0x93, -0x98, -0x9d, -0xa2, -0xa7, -0xab, -0xb0,
    -0xb5, -0xb9, -0xbd,  -0xc1, -0xc5, -0xc9, -0xcd, -0xd1, -0xd4, -0xd8,
    -0xdb, -0xde, -0xe1,  -0xe4, -0xe7, -0xea, -0xec, -0xee, -0xf1, -0xf3,
    -0xf4, -0xf6, -0xf8,  -0xf9, -0xfb, -0xfc, -0xfd, -0xfe, -0xfe, -0xff,
    -0xff, -0xff, -0x100, -0xff, -0xff, -0xff, -0xfe, -0xfe, -0xfd, -0xfc,
    -0xfb, -0xf9, -0xf8,  -0xf6, -0xf4, -0xf3, -0xf1, -0xee, -0xec, -0xea,
    -0xe7, -0xe4, -0xe1,  -0xde, -0xdb, -0xd8, -0xd4, -0xd1, -0xcd, -0xc9,
    -0xc5, -0xc1, -0xbd,  -0xb9, -0xb5, -0xb0, -0xab, -0xa7, -0xa2, -0x9d,
    -0x98, -0x93, -0x8e,  -0x88, -0x83, -0x7e, -0x78, -0x75, -0x6d, -0x67,
    -0x61, -0x5c, -0x56,  -0x50, -0x4a, -0x44, -0x3e, -0x38, -0x31, -0x2b,
    -0x25, -0x1f, -0x19,  -0x12, -0x0c, -0x06, 0x00,  0x06,  0x0c,  0x12,
    0x19,  0x1f,  0x25,   0x2b,  0x31,  0x38,  0x3e,  0x44,  0x4a,  0x50,
    0x56,  0x5c,  0x61,   0x67,  0x6d,  0x73,  0x78,  0x7e,  0x83,  0x88,
    0x8e,  0x93,  0x98,   0x9d,  0xa2,  0xa7,  0xab,  0xb0,  0xb5,  0xb9,
    0xbd,  0xc1,  0xc5,   0xc9,  0xcd,  0xd1,  0xd4,  0xd8,  0xdb,  0xde,
    0xe1,  0xe4,  0xe7,   0xea,  0xec,  0xee,  0xf1,  0xf3,  0xf4,  0xf6,
    0xf8,  0xf9,  0xfb,   0xfc,  0xfd,  0xfe,  0xfe,  0xff,  0xff,  0xff
};
ROMFUNC(rom_29D2) {
  D0 &= 0xFF;
  SETWORD(D1, Sine_Data[D0 + 0x40]);
  SETWORD(D0, Sine_Data[D0]);
}
static const u8 Angle_Data[] = {
    0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x02, 0x02,
    0x02, 0x02, 0x02, 0x02, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x04,
    0x04, 0x04, 0x04, 0x04, 0x04, 0x05, 0x05, 0x05, 0x05, 0x05, 0x05, 0x06,
    0x06, 0x06, 0x06, 0x06, 0x06, 0x06, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
    0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x09, 0x09, 0x09, 0x09, 0x09,
    0x09, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0A, 0x0B, 0x0B, 0x0B, 0x0B,
    0x0B, 0x0B, 0x0B, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0D, 0x0D,
    0x0D, 0x0D, 0x0D, 0x0D, 0x0D, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E,
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x10, 0x10, 0x10, 0x10, 0x10,
    0x10, 0x10, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x12, 0x12,
    0x12, 0x12, 0x12, 0x12, 0x12, 0x13, 0x13, 0x13, 0x13, 0x13, 0x13, 0x13,
    0x13, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x15, 0x15, 0x15,
    0x15, 0x15, 0x15, 0x15, 0x15, 0x15, 0x16, 0x16, 0x16, 0x16, 0x16, 0x16,
    0x16, 0x16, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x17, 0x18,
    0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x19, 0x19, 0x19, 0x19,
    0x19, 0x19, 0x19, 0x19, 0x19, 0x19, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A,
    0x1A, 0x1A, 0x1A, 0x1B, 0x1B, 0x1B, 0x1B, 0x1B, 0x1B, 0x1B, 0x1B, 0x1B,
    0x1B, 0x1C, 0x1C, 0x1C, 0x1C, 0x1C, 0x1C, 0x1C, 0x1C, 0x1C, 0x1C, 0x1C,
    0x1D, 0x1D, 0x1D, 0x1D, 0x1D, 0x1D, 0x1D, 0x1D, 0x1D, 0x1D, 0x1D, 0x1E,
    0x1E, 0x1E, 0x1E, 0x1E, 0x1E, 0x1E, 0x1E, 0x1E, 0x1E, 0x1E, 0x1F, 0x1F,
    0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x00};
ROMFUNC(rom_2C6A) {
  u32 d3backup = 0;
  u32 d4backup = 0;
  d3backup = D3;
  d4backup = D4;                                // TODO; // MOVEM.L	D3-D4,-(A7)
  D3 = GETWORD(D1);    // MOVE.W	D1,D3
  D4 = GETWORD(D2);    // MOVE.W	D2,D4
  if ((D3 | D4) == 0) { // BEQ.B	$2CC6
	D0 = 0x40; // MOVE.W	#$0040,D0
  	D3 = d3backup;
  	D4 = d4backup;             // TODO; // MOVEM.L	(A7)+,D3-D4
  	return; // RTS
  }
  D3 = abs((s16)D3);
  D4 = abs((s16)D4);
  if (GETWORD(D4) < GETWORD(D3)) { // BCC.W	$2C9E
	D4 <<= 8;
	D4 /= D3;
	D0 = Angle_Data[D4];
  } else {
	D3 <<= 8;
	D3 /= D4;
	D0 = 0x40;
	D0 -= Angle_Data[D3];
  }
  if (((s16)D1) < 0) {
	SETWORD(D0, -D0 + 0x80);
  }
  if (((s16)D2) < 0) {
	SETWORD(D0, -D0 + 0x100);
  }
  D3 = d3backup;
  D4 = d4backup;                               // TODO; // MOVEM.L	(A7)+,D3-D4
}
ROMFUNC(rom_411A) {
  DEF_ROMLOC(411A) : move_toreg_32(0xFFFFFE5E, &A1); // LEA.L	$FE5E,A1
  DEF_ROMLOC(411E) : move_toreg_32(0x412E, &A2);     // LEA.L	$0000412E,A2
  DEF_ROMLOC(4124) : move_toreg_32(0x20, &D1);       // MOVEQ.L	$20,D1
  DEF_ROMLOC(4126)
      : move_tomem_16(read_16((A2 += 2, A2 - 2)),
                      (A1 += 2, A1 - 2)); // MOVE.W	(A2)+,(A1)+
  DEF_ROMLOC(4128) : dec_reg_16(&D1);
  if ((D1 & 0xffff) != 0xffff)
    goto rom_4126;           // DBF.W	D1,$4126
}
ROMFUNC(rom_4170) {
  DEF_ROMLOC(4170) : cmp_tomem_8(0x6, 0xFFFFD024);   // CMPI.B	#$06,$D024
  DEF_ROMLOC(4176) : if (CCR_CC) return;      // BCC.B	$41C6
  DEF_ROMLOC(4178) : move_toreg_32(0xFFFFFE5E, &A1); // LEA.L	$FE5E,A1
  DEF_ROMLOC(417C) : move_toreg_32(0x41C8, &A2);     // LEA.L	$000041C8,A2
  DEF_ROMLOC(4182)
      : move_toreg_16(read_16((A1 += 2, A1 - 2)), &D3); // MOVE.W	(A1)+,D3
  DEF_ROMLOC(4184) : move_toreg_32(0xF, &D1);           // MOVEQ.L	$0F,D1
  DEF_ROMLOC(4186)
      : move_toreg_16(read_16((A2 += 2, A2 - 2)), &D2); // MOVE.W	(A2)+,D2
  DEF_ROMLOC(4188)
      : move_toreg_16(read_16((A2 += 2, A2 - 2)), &D4); // MOVE.W	(A2)+,D4
  DEF_ROMLOC(418A) : btst_toreg_32(D1, &D3);            // BTST.L	D1,D3
  DEF_ROMLOC(418C) : if (!CCR_EQ) goto rom_41A6;        // BNE.B	$41A6
  DEF_ROMLOC(418E)
      : move_toreg_16(read_16(A1 + 0x2), &D0);           // MOVE.W	2(A1),D0
  DEF_ROMLOC(4192) : add_toreg_16(D2, &D0);              // ADD.W	D2,D0
  DEF_ROMLOC(4194) : move_tomem_16(D0, A1 + 0x2);        // MOVE.W	D0,2(A1)
  DEF_ROMLOC(4198) : add_tomem_16(D0, A1 + 0x0);         // ADD.W	D0,0(A1)
  DEF_ROMLOC(419C) : cmp_toreg_8(read_8(A1 + 0x0), &D4); // CMP.B	0(A1),D4
  DEF_ROMLOC(41A0) : if (CCR_HI) goto rom_41BC;          // BHI.B	$41BC
  DEF_ROMLOC(41A2) : bset_toreg_32(D1, &D3);             // BSET.L	D1,D3
  DEF_ROMLOC(41A4) : goto rom_41BC;                      // BRA.B	$41BC
  DEF_ROMLOC(41A6)
      : move_toreg_16(read_16(A1 + 0x2), &D0);           // MOVE.W	2(A1),D0
  DEF_ROMLOC(41AA) : sub_toreg_16(D2, &D0);              // SUB.W	D2,D0
  DEF_ROMLOC(41AC) : move_tomem_16(D0, A1 + 0x2);        // MOVE.W	D0,2(A1)
  DEF_ROMLOC(41B0) : add_tomem_16(D0, A1 + 0x0);         // ADD.W	D0,0(A1)
  DEF_ROMLOC(41B4) : cmp_toreg_8(read_8(A1 + 0x0), &D4); // CMP.B	0(A1),D4
  DEF_ROMLOC(41B8) : if (CCR_LS) goto rom_41BC;          // BLS.B	$41BC
  DEF_ROMLOC(41BA) : bclr_toreg_32(D1, &D3);             // BCLR.L	D1,D3
  DEF_ROMLOC(41BC) : add_toreg_16(0x4, &A1);             // ADDQ.W	#$04,A1
  DEF_ROMLOC(41BE) : dec_reg_16(&D1);
  if ((D1 & 0xffff) != 0xffff)
    goto rom_4186;                                  // DBF.W	D1,$4186
  DEF_ROMLOC(41C2) : move_tomem_16(D3, 0xFFFFFE5E); // MOVE.W	D3,$FE5E
}